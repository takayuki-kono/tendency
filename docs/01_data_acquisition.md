# データ収集ドキュメント (Stage 1)

本ドキュメントでは、Web上からの画像収集および初期処理（顔検出・クロップ）について詳述します。

## 概要フロー
**スクリプト**: `download_and_filter_faces.py`
**役割**: キーワードに基づく画像の収集、顔検出、クロップ、保存。

---

## 処理詳細

### 1. メインスクリプト: `download_and_filter_faces.py`
ユーザーが定義した `KEYWORDS` リスト（人物名）に基づき、以下のコンポーネントを呼び出して収集パイプラインを実行します。

### 2. コンポーネント: `components/part1_setup.py`

#### A. 画像収集
以下の2つのソースから画像を収集します。

1.  **Bing Image Search**
    -   **ツール**: `icrawler.builtin.BingImageCrawler`
    -   **特徴**: メインの収集元。安定して大量の画像を収集可能。
    -   **設定**: `MAX_NUM` で枚数を制限。

2.  **Google Image Search**
    -   **ツール**: `requests` + `BeautifulSoup` (独自実装)
    -   **特徴**: 初期検索結果（約20枚程度）を高速に収集。Bingの補助として使用。
    -   **詳細仕様**: `docs/add_google_scraping.md` を参照。

#### B. 顔検出 & クロップ (InsightFace)
収集した生画像に対して、以下の処理を行います。

1.  **顔検出**: `insightface.app.FaceAnalysis` を使用し、画像内の顔をすべて検出。
2.  **回転補正 (Alignment)**:
    -   検出された `landmark_2d_106` を使用。
    -   顔の中心軸を計算し、画像の傾きを補正して正立（Rotation）させます。
3.  **領域クロップ**:
    -   眉の上から顎の下までを含む領域を切り出します。
    -   **画像サイズ**: `224x224` px にリサイズして保存。
    -   **保存先**: `master_data/{人物名}/rotated/`

#### C. パディングチェック
極端なパディング（黒帯）が発生してしまうような構図（顔が端すぎるなど）の場合、その顔はスキップされます。

---

## 補足: Google収集機能の追加背景
`icrawler` の `GoogleImageCrawler` が不安定であったため、軽量なスクレイピングロジックを追加実装しました。
これにより、Bingだけでは拾いきれない種類の画像（Google検索上位の代表的な画像など）をカバーします。
