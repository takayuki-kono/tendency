# データ収集ドキュメント (Stage 1)

本ドキュメントでは、Web上からの画像収集および初期処理（顔検出・クロップ）について詳述します。

## 概要フロー
**スクリプト**: `download_and_filter_faces.py`
**役割**: 複数エンジンによる高画質画像の収集、顔検出、正立補正、224x224クロップ、および重複・別人の排除。

---

## 処理詳細 (Stage 1)

### 1. メインパイプライン: `download_and_filter_faces.py`
指定された人物名に基づき、以下の3ステップを自動実行します。

### ステップ 1: 画像収集と顔抽出 (`components/part1_setup.py`)
従来の icrawler に代わり、より高品質・大量収集が可能な **`pyimagedl`** 方式に完全移行しました。

-   **使用エンジン**: Yahoo, Bing, Baidu, Google
-   **収集戦略**: 
    -   キーワードを「〇〇 女優」に固定し、各エンジンの検索上位から純度の高い画像を収集。
    -   「Large Size」フィルタを適用し、高解像度の元画像のみをダウンロード。
    -   **上限設定**: 各エンジンあたり最大 **1000枚** を目標に収集。
-   **顔加工 (InsightFace)**:
    -   ダウンロード直後に顔を検出し、**正立補正 (Rotation Alignment)** を実施。
    -   **クロップ仕様**: 顔のランドマーク検出に基づき、**顎の先端（Landmark #0）を画像の下底**に合わせて切り出し（眉上～顎）。
    -   `224x224` px にリサイズ。
    -   パディング（黒帯）制限は無効化されており、多少の余白があっても保存されます。
-   **セキュリティ対策 (2026-01-27 追加)**:
    -   **ファイル検証**: マジックナンバー（ヘッダー）を確認し、真の画像ファイル（JPEG, PNG, BMP, WEBP）以外を排除。
    -   **URLフィルタ**: 実行ファイル（.exe, .scr等）やスクリプト（.js, .vbs等）を含むURLを事前にブロック。
    -   **サイズ制限**: 極端に小さいファイル（<100B）や巨大なファイル（>20MB）をダウンロード・処理対象外とします。
-   **保存先**: `master_data/{人物名}/rotated/` (中間ディレクトリ)
-   **補足**: ディレクトリ内に未加工の生ファイルが残存した場合、自動的に検出して加工プロセス(`components/process_local_raw.py`)を実行します。

### ステップ 2: 重複排除 (`components/part2a_similarity.py`)
収集した顔画像の中から、同一画像や極めて似ている画像を削除します。
-   **保存先**: `deleted_duplicates/` (論理削除の場合)

### ステップ 3: 人物選別 (`components/part2b_filter.py`)
クラスタリングにより、対象人物以外の顔（共演者や誤検出など）を自動排除します。
-   **処理後**: 正常な画像は `master_data/{人物名}/` 直下に移動され、`rotated` フォルダは削除されます。
-   **保存先**: `deleted_outliers/` (論理削除の場合)

---

## 変更履歴
- **2026-01-27**: ダウンロード時のセキュリティ強化（拡張子フィルタ、ヘッダー検証、サイズ制限）を実装。収集対象キーワードを更新。
- **2026-01-13**: 収集時のフリーズ対策として `socket.setdefaulttimeout(20.0)` を追加。
- **2025-12-29**: 収集対象のキーワードリストを更新（54名の女優リストをハードコピー）。
- **2025-12-28 (5)**: クロップロジックを改善（顎位置を画像下端に固定）。既存フォルダの自動クリーンアップ機能と、ローカル生ファイル処理(`process_local_raw.py`)を追加。
- **2025-12-28 (4)**: `download_and_filter_faces.py` の内部エンジンを全面的に `imagedl` ベースに移行。Yahoo, Baiduを含むマルチエンジン体制へ。

## Author
Gemini