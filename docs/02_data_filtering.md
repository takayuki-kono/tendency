# データフィルタリング・前処理ドキュメント (Stage 2)

本ドキュメントでは、収集後の画像の選別（フィルタリング）およびデータセット構成について詳述します。

## 概要フロー
1. **重複・外れ値除去**: `components/part2a`, `part2b`
2. **構造整理**: `reorganize_by_label.py`
3. **データ分割**: `create_person_split.py`
4. **詳細前処理**: `preprocess_multitask.py`

---

## 1. 初期クリーニング

### A. 類似画像除去 (`components/part2a_similarity.py`)
- **目的**: 連写やリポストによる重複画像を削除します。
- **手法**:
    - InsightFaceのFace Embedding (512次元) を抽出。
    - **DBSCANクラスタリング** (`eps`閾値設定) を行い、距離が非常に近い画像をグループ化。
    - グループ内で1枚だけ残し、他を削除。

### B. 外れ値除去 (`components/part2b_filter.py`)
- **目的**: 検索ノイズ（同姓同名の別人、間違って検出された群衆の顔など）を除去します。
- **手法**:
    - 再びEmbeddingを用いてクラスタリング。
    - 最も画像枚数が多いクラスタを「本人」と見なし、それ以外の小規模クラスタを「外れ値（ノイズ）」として除去します。

---

## 2. データセット構造化 (Stage 2a)

### ラベル整理 (`reorganize_by_label.py`)
- `master_data/{人物名}/` の構造を、学習タスクに合わせて `master_data/{ラベル}/{人物名}/` に再配置します。
- マッピング定義に基づき移動します。

### Train/Val/Test 分割 (`create_person_split.py`)
- **重要ルール**: **Person-wise Split (人物単位分割)**
- 同じ人物の画像がTrainとTestに混ざると、モデルが「顔の特徴（個人性）」を覚えてしまい、正しく汎化性能を評価できません。
- そのため、画像をランダム分割するのではなく、**「人物AはTrain、人物BはTest」**のように人物単位で振り分けます。

---

## 3. 詳細フィルタリング (Stage 2b)

### スクリプト: `preprocess_multitask.py`
最終的な学習用データセットを作成するために、画像品質に基づくフィルタリングを行います。

### 主なフィルタ項目
パラメータは `optimize_sequential.py` で最適化されることがあります。

1.  **Sharpness (鮮明度)**
    -   手法: **Laplacian Variance** (エッジの鋭さ) を計算。
    -   動作: 値が低い（ボケている）画像を除外。
2.  **Pitch (顔の縦向き)**
    -   InsightFaceのPose推定値を使用。
    -   大きく上や下を向いている顔を除外。
3.  **Symmetry (左右対称性)**
    -   左右の内眼角（目頭）と画像の中心との距離比から算出。
    -   真正面を向いているかを判定し、横顔に近い画像を除外。
4.  **Face Position (顔位置)**
    -   内眼角の座標を用いて、顔が画像の極端な端にないかを判定。
4.  **Eyebrow-Eye Distance**
    -   目と眉の距離の比率。
    -   表情のゆがみや、特徴が隠れている顔を除外。

### 出力
フィルタを通過した画像のみが `preprocessed_multitask/` フォルダに出力されます。これが学習 (`train_sequential.py`) の直接の入力となります。
